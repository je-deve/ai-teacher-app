<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Reading Assessment | Generations Abilities Schools</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* Same CSS as before - Preserved */
:root{
    --primary-brown:#5D4037;
    --gold-dark:#B8860B;
    --gold-light:#F2D06B;
    --gold-gradient:linear-gradient(135deg,#D4AF37,#F2D06B);
    --navbar-height:80px;
}
body{
    font-family:'Cairo',sans-serif;
    background:#f5f5f5;
    margin:0;
    padding-top:calc(var(--navbar-height) + 20px);
    color:var(--primary-brown);
}
.navbar{
    position:fixed; top:0; left:0; right:0; height:var(--navbar-height);
    background:white; border-bottom:3px solid var(--gold-dark);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 5%; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,0.05);
}
.nav-left{ display:flex; align-items:center; gap:15px; }
.nav-logo{ height:60px; }
.nav-links a{ text-decoration:none; font-weight:700; color:var(--primary-brown); margin:0 8px; }
.school-name{ font-size:20px; font-weight:700; color:var(--primary-brown); }
.container{ display:flex; justify-content:center; padding:20px; }
.card{
    background:white; width:100%; max-width:650px; padding:40px;
    border-radius:20px; box-shadow:0 10px 40px rgba(93,64,55,0.1);
    border:1px solid #eee; text-align:center;
}
h2{ margin-bottom:30px; color:var(--primary-brown); }
.input-group{ margin-bottom:20px; text-align:left; }
.input-group label{ display:block; margin-bottom:8px; font-weight:600; }
input,textarea{
    width:100%; padding:14px; border:2px solid #E0E0E0; border-radius:10px;
    font-family:'Cairo'; font-size:15px; background:#FAFAFA; transition:.3s; box-sizing:border-box;
}
input:focus,textarea:focus{ border-color:var(--gold-dark); background:white; outline:none; }
textarea{ height:110px; resize:none; }
.tabs-container{
    background:#F5F5F5; padding:5px; border-radius:12px;
    display:flex; margin-bottom:25px;
}
.tab-btn{
    flex:1; padding:12px; border:none; background:transparent; border-radius:8px;
    cursor:pointer; font-family:'Cairo'; font-weight:600; color:#757575; transition:.3s;
}
.tab-btn.active{
    background:white; color:var(--primary-brown); border:1px solid var(--gold-dark);
    box-shadow:0 2px 5px rgba(0,0,0,0.05);
}
.action-btn{
    width:100%; padding:15px; border:none; border-radius:12px;
    font-family:'Cairo'; font-weight:700; font-size:16px; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:10px;
    transition:.2s; color:white;
}
.btn-record{ background:#1976D2; }
.btn-stop{ background:#212121; }
.btn-main{
    background:var(--gold-gradient); color:var(--primary-brown); margin-top:25px;
    box-shadow:0 5px 15px rgba(212,175,55,.4);
}
.action-btn:hover{ opacity:.95; transform:translateY(-2px); }
.upload-area{
    border:2px dashed #D7CCC8; border-radius:12px; padding:30px;
    cursor:pointer; transition:.3s; position:relative; background:#FFFCF2;
}
.upload-area:hover{ border-color:var(--gold-dark); background:#FFF8E1; }
.upload-icon{ font-size:28px; color:var(--gold-dark); margin-bottom:10px; }
.upload-area input{ position:absolute; width:100%; height:100%; top:0; left:0; opacity:0; cursor:pointer; }
.hidden{ display:none!important; }
.timer{ font-size:24px; font-weight:bold; color:var(--gold-dark); margin:15px 0; display:none; }
.status-box{ margin-top:15px; font-size:14px; font-weight:600; }
.status-loading{ color:var(--gold-dark); }
.status-success{ color:#388E3C; }
.status-error{ color:#D32F2F; }
</style>
</head>

<body>

  <nav class="navbar">
    <div style="display:flex;align-items:center;gap:15px;">
      <img src="/static/logo.png" alt="Logo" class="nav-logo">
      <div class="nav-links">
        <a href="/arabic">العربية</a> |
        <a href="/english">English</a> |
        <a href="/">الرئيسية</a>
      </div>
    </div>
    <div>
      <span class="school-name">مدارس قدرات الأجيال العالمية</span>
    </div>
  </nav>
<div class="container">
    <div class="card">
        <h2>English Reading Assessment System</h2>

        <div class="input-group">
            <label>Student Name</label>
            <input id="studentName" placeholder="Enter student name">
        </div>

        <div class="input-group">
            <label>Reference Text</label>
            <textarea id="refText" placeholder="Enter the reference reading text here..."></textarea>
        </div>

        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab(event,'record')">
                <i class="fa-solid fa-microphone"></i> Live Recording
            </button>
            <button class="tab-btn" onclick="switchTab(event,'upload')">
                <i class="fa-solid fa-cloud-arrow-up"></i> Upload Audio
            </button>
        </div>

        <div id="recordSection">
            <button id="startBtn" class="action-btn btn-record" onclick="startRecording()">
                <i class="fa-solid fa-circle"></i> Start Recording
            </button>
            <button id="stopBtn" class="action-btn btn-stop hidden" onclick="stopRecording()">
                <i class="fa-solid fa-stop"></i> Stop Recording
            </button>
            <div id="timer" class="timer">00:00</div>
        </div>

        <div id="uploadSection" class="hidden">
            <div class="upload-area">
                <input type="file" id="fileInput" accept="audio/*" onchange="handleFileSelect()">
                <i class="fa-solid fa-file-audio upload-icon"></i>
                <div id="fileName">Click to select audio file (MP3 / WAV)</div>
            </div>
        </div>

        <audio id="audioPreview" controls style="width:100%; margin-top:20px; display:none; border-radius:10px;"></audio>

        <button id="analyzeBtn" class="action-btn btn-main" onclick="analyze()">
            <i class="fa-solid fa-wand-magic-sparkles"></i> Analyze & Generate Report
        </button>

        <div id="status" class="status-box"></div>
    </div>
</div>

<script>
    // --- Safe Element Selection ---
    const statusBox = document.getElementById('status');
    const studentNameInput = document.getElementById('studentName');
    const refTextInput = document.getElementById('refText');
    const recordSection = document.getElementById('recordSection');
    const uploadSection = document.getElementById('uploadSection');
    const audioPreview = document.getElementById('audioPreview');
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileName');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const timerDisplay = document.getElementById('timer');

    let mediaRecorder, audioChunks = [], audioBlob = null;
    let mode = 'record';
    let timerInterval, startTime;

    function switchTab(ev, selected) {
        mode = selected;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        ev.currentTarget.classList.add('active');

        if (selected === 'record') {
            recordSection.classList.remove('hidden');
            uploadSection.classList.add('hidden');
        } else {
            recordSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
        }

        audioPreview.style.display = 'none';
        statusBox.innerText = '';
    }

    function handleFileSelect() {
        if (fileInput.files.length > 0) {
            fileNameDisplay.innerText = "Selected: " + fileInput.files[0].name;
            audioPreview.src = URL.createObjectURL(fileInput.files[0]);
            audioPreview.style.display = 'block';
        }
    }

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            audioChunks = [];
            audioBlob = null;

            startTime = Date.now();
            timerDisplay.style.display = 'block';
            timerInterval = setInterval(() => {
                let diff = Math.floor((Date.now() - startTime) / 1000);
                let m = Math.floor(diff / 60).toString().padStart(2, '0');
                let s = (diff % 60).toString().padStart(2, '0');
                timerDisplay.innerText = `${m}:${s}`;
            }, 1000);

            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                clearInterval(timerInterval);
                timerDisplay.style.display = 'none';
                audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioPreview.src = URL.createObjectURL(audioBlob);
                audioPreview.style.display = 'block';
                
                // Stop all tracks to release microphone
                stream.getTracks().forEach(track => track.stop());
            };
        } catch (err) {
            alert("Microphone access denied or error: " + err);
        }
    }

    function stopRecording() {
        if (mediaRecorder) mediaRecorder.stop();
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
    }

    async function analyze() {
        const name = studentNameInput.value.trim();
        const text = refTextInput.value.trim();

        // 1. Validation
        if (!name || !text) {
            statusBox.innerText = 'Please fill all fields (Name & Reference Text)';
            statusBox.className = 'status-box status-error';
            return;
        }

        let fd = new FormData();
        fd.append('name', name);
        fd.append('ref_text', text);

        // 2. Audio Validation
        if (mode === 'record') {
            if (!audioBlob) {
                statusBox.innerText = 'Please record audio first';
                statusBox.className = 'status-box status-error';
                return;
            }
            fd.append('audio_record', audioBlob, 'rec.wav');
        } else {
            if (fileInput.files.length === 0) {
                statusBox.innerText = 'Please upload an audio file';
                statusBox.className = 'status-box status-error';
                return;
            }
            fd.append('audio_upload', fileInput.files[0]);
        }

        // 3. Status Update
        statusBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing... Please wait.';
        statusBox.className = 'status-box status-loading';

        // 4. Send Request
        try {
            const res = await fetch('/analyze_english', {
                method: 'POST',
                body: fd
            });

            if (res.ok) {
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `English_Report_${name.replace(/\s+/g, '_')}.pdf`;
                document.body.appendChild(a); // Required for some browsers
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // Cleanup
                
                statusBox.innerText = 'Report generated successfully! Download starting...';
                statusBox.className = 'status-box status-success';
            } else {
                const msg = await res.text();
                statusBox.innerText = 'Server Error: ' + msg;
                statusBox.className = 'status-box status-error';
            }
        } catch (error) {
            console.error(error);
            statusBox.innerText = 'Network Error: Failed to connect to server.';
            statusBox.className = 'status-box status-error';
        }
    }
</script>

</body>
</html>